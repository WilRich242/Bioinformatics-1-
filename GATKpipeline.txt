#!/bin/bash 
#SBATCH --mem=30G
#SBATCH --time=8:00:00
#SBATCH --nodes=1

module load picard/2.18.14

module load GATK/4.2.2

picard MarkDuplicates \
      I=S37_BRCA1.bam \
      O=marked_duplicates.bam \
      M=marked_dup_metrics.txt
	  

gatk SplitNCigarReads \
      -R /scratch/jl1e18/BRCA1_temp/references/GRCh38.primary_assembly.genome.fa\
      -I marked_duplicates.bam \
      -O SNCRresults.bam
	  

picard AddOrReplaceReadGroups \
       I=SNCRresults.bam \
       O=RG_SNCRresults.bam \
       RGID=4 \
       RGLB=lib1 \
       RGPL=ILLUMINA \
       RGPU=unit1 \
       RGSM=20
	   

gatk BaseRecalibrator \
   -I RG_SNCRresults.bam \
   -R references/GRCh38.primary_assembly.genome.fa \
   --known-sites references/Homo_sapiens_assembly38.dbsnp138.vcf \
   -O recal_data.table
   

gatk ApplyBQSR \
   -R references/GRCh38.primary_assembly.genome.fa \
   -I RG_SNCRresults.bam \
   --bqsr-recal-file recal_data.table \
   -O ApplyBQSRresults.bam
 

gatk HaplotypeCaller  \
   -R references/GRCh38.primary_assembly.genome.fa \
   -I ApplyBQSRresults.bam \
   -O Genotype.g.vcf.gz \
   -ERC GVCF \
   -G StandardAnnotation \
   -G AS_StandardAnnotation
   

gatk VariantFiltration \
   -R references/GRCh38.primary_assembly.genome.fa \
   -V Genotype.g.vcf.gz \
   -O FilteredVariants.vcf.gz \
   --filter-name "my_filter1" \
   --filter-expression "AB < 0.2" \
   --filter-name "my_filter2" \
   --filter-expression "MQ0 > 50"
 